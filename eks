 stage('starting RDS cluster') {
        steps{
        script{
          withAWS(region: CICD_REGION, roleAccount: CICD_ACCOUNT_ID, role: CICD_REGION_ROLE, duration: 3600) {
            withAWS(region: AWS_DEPLOYMENT_REGION, roleAccount: AWS_ACCOUNT_ID, role: AWS_IAM_ROLE_NAME, duration: 3600) {
            
             if("$rds_cluster"!="none"){
              switch("$op_rds"){
                case "Start" :
                 
                      try {
                          db_start = sh(script: "aws rds start-db-cluster --db-cluster-identifier $rds_cluster |  xargs", returnStdout:true).trim()
                          echo "RDS cluster $rds_cluster will be available "
                      }
                      catch(err){
                          echo "ERROR CAUGHT: $err"
                      }
                    
                 break;

              case "Stop" :
                try {
                          db_start = sh(script: "aws rds stop-db-cluster --db-cluster-identifier $rds_cluster |  xargs", returnStdout:true).trim()
                          echo "RDS cluster $rds_cluster will be stopped "
                      }
                      catch(err){
                          echo "ERROR CAUGHT: $err"
                      }
                  break;
              case "Status" :
                     try{  db_status = sh(
                          script: "aws rds describe-db-clusters --db-cluster-identifier $rds_cluster --query DBClusters[0].Status | xargs", returnStdout:true
                        ).trim()
                        echo "DB Status: $db_status"

                        while(db_status != "available"){
                          echo "DB Cluster Not Available. Sleeping for 60 seconds..."
                          sleep(60)
                          db_status = sh(
                            script: "aws rds describe-db-clusters --db-cluster-identifier $rds_cluster --query DBClusters[0].Status | xargs", returnStdout:true
                          ).trim()
                          echo "DB Status: $db_status"
                        }
                      }
                    catch(err){
                        echo "ERROR CAUGHT: $err"
                      }
                  break;
                   default :
                  echo "NO operation"
                  break;
                }
             }
             else{
              echo "No RDS cluster was selected"
             }
             
            }
          }
          echo "Environment is now up and available. Please confirm applications are running properly"
        }
      }
    }
